class ComplexPlaneWave:
â€œâ€â€œA 2D plane wave source following Lumericalâ€™s approachâ€â€â€

```
def __init__(
    self,
    # æ”¯æ´å…©ç¨®ä»‹é¢æ–¹å¼
    wavelength: float = None,           # åŸæœ‰çš„å–®æ³¢é•·ä»‹é¢
    wavelength_min: float = None,       # æ–°å¢ï¼šLumerical é¢¨æ ¼ä»‹é¢
    wavelength_max: float = None,       # æ–°å¢ï¼šLumerical é¢¨æ ¼ä»‹é¢
    
    # å…¶ä»–åƒæ•¸ä¿æŒä¸è®Š
    amplitude: complex = 1.0 + 0.0j,
    phase_shift: float = 0.0,
    theta_deg: float = 0.0,
    polarization_axis: str = "x",
    name: str = None,
    
    # è„ˆè¡åƒæ•¸ - æ”¹ç‚ºè‡ªå‹•è¨ˆç®—
    pulse: bool = None,                 # None = è‡ªå‹•æ±ºå®š
    cycle: int = None,                  # None = è‡ªå‹•è¨ˆç®—
    optimize_for_short_pulse: bool = True,  # æ–°å¢ï¼šæ¨¡ä»¿ Lumerical é¸é …
    
    hanning_dt: float = None,
    medium_n: float = None
):
    """
    å‰µå»ºComplexPlaneWaveï¼Œæ”¯æ´ Lumerical é¢¨æ ¼çš„æ³¢é•·è¨­å®š
    
    ä½¿ç”¨æ–¹å¼ï¼š
    1. åŸæœ‰æ–¹å¼ï¼šwavelength=1550e-9  
    2. Lumerical é¢¨æ ¼ï¼šwavelength_min=1500e-9, wavelength_max=1600e-9
    3. å–®é » Lumerical é¢¨æ ¼ï¼šwavelength_min=1550e-9, wavelength_max=1550e-9
    """
    
    # è§£ææ³¢é•·è¨­å®š
    self._parse_wavelength_input(wavelength, wavelength_min, wavelength_max)
    
    # åŸºæœ¬åƒæ•¸
    self.amplitude = amplitude
    self.phase_shift = phase_shift
    self.theta_deg = theta_deg
    self.theta = bd.deg2rad(theta_deg)
    self.polarization_axis = polarization_axis.lower()
    self.name = name
    self.n = medium_n if medium_n is not None else 1.0
    self.optimize_for_short_pulse = optimize_for_short_pulse
    
    # è¨ˆç®—é »ç‡åƒæ•¸ï¼ˆä½¿ç”¨ä¸­å¿ƒæ³¢é•·ï¼‰
    self.frequency = bd.c0 / self.n / self.wavelength  # Hz
    self.period = 1.0 / self.frequency  # ç§’
    self.omega = 2 * bd.pi * self.frequency  # rad/s
    self.k = 2 * np.pi / self.wavelength  # 1/m
    
    # Lumerical é¢¨æ ¼ï¼šç¸½æ˜¯ä½¿ç”¨è„ˆè¡ï¼Œè‡ªå‹•è¨ˆç®—åƒæ•¸
    self._setup_lumerical_pulse_params(pulse, cycle)
    
    # åˆå§‹åŒ–å…¶ä»–å±¬æ€§ï¼ˆä¿æŒåŸæœ‰çµæ§‹ï¼‰
    self.grid = None
    self.period_sim = None
    self.frequency_sim = None
    self.omega_sim = None
    self.hanning_dt_sim = None
    self.hanning_dt = hanning_dt
    
    # monitor source propertiesï¼ˆä¿æŒåŸæœ‰ï¼‰
    self.monitoring_enabled = False
    self.monitor_data = {
        'timesteps': [],
        'E_field': [],
        'envelope': [],
        'phase': []
    }

def _parse_wavelength_input(self, wavelength, wavelength_min, wavelength_max):
    """è§£ææ³¢é•·è¼¸å…¥åƒæ•¸"""
    
    # è¨ˆç®—è¨­å®šäº†å¤šå°‘ç¨®æ–¹å¼
    old_style = wavelength is not None
    new_style = wavelength_min is not None or wavelength_max is not None
    
    if old_style and new_style:
        raise ValueError("ä¸èƒ½åŒæ™‚ä½¿ç”¨èˆŠå¼ (wavelength) å’Œæ–°å¼ (wavelength_min/max) åƒæ•¸")
    
    if old_style:
        # èˆŠå¼ï¼šå–®ä¸€æ³¢é•·
        self.wavelength = wavelength
        self.wavelength_min = wavelength
        self.wavelength_max = wavelength
        self.input_style = "legacy"
        
    elif new_style:
        # æ–°å¼ï¼šLumerical é¢¨æ ¼
        if wavelength_min is None or wavelength_max is None:
            raise ValueError("ä½¿ç”¨ Lumerical é¢¨æ ¼æ™‚ï¼Œå¿…é ˆåŒæ™‚è¨­å®š wavelength_min å’Œ wavelength_max")
            
        if wavelength_min <= 0 or wavelength_max <= 0:
            raise ValueError("æ³¢é•·å¿…é ˆå¤§æ–¼ 0")
        if wavelength_min > wavelength_max:
            raise ValueError("wavelength_min ä¸èƒ½å¤§æ–¼ wavelength_max")
            
        self.wavelength_min = wavelength_min
        self.wavelength_max = wavelength_max
        self.wavelength = (wavelength_min + wavelength_max) / 2  # ä¸­å¿ƒæ³¢é•·
        self.input_style = "lumerical"
        
    else:
        raise ValueError("å¿…é ˆè¨­å®š wavelength æˆ– (wavelength_min, wavelength_max)")
    
    # è¨ˆç®—é »è­œç‰¹æ€§
    self.wavelength_span = self.wavelength_max - self.wavelength_min
    self.frequency_center = bd.c0 / self.n / self.wavelength
    self.frequency_min = bd.c0 / self.n / self.wavelength_max  # æ³¨æ„åå‘
    self.frequency_max = bd.c0 / self.n / self.wavelength_min
    self.frequency_bandwidth = self.frequency_max - self.frequency_min
    self.relative_bandwidth = self.wavelength_span / self.wavelength if self.wavelength > 0 else 0
    
    # åˆ¤æ–·æ˜¯å¦ç‚ºå–®é »
    tolerance = 1e-12
    self.is_single_frequency = abs(self.wavelength_max - self.wavelength_min) < tolerance

def _setup_lumerical_pulse_params(self, pulse_override, cycle_override):
    """è¨­å®š Lumerical é¢¨æ ¼çš„è„ˆè¡åƒæ•¸"""
    
    # Lumerical é¢¨æ ¼ï¼šç¸½æ˜¯ä½¿ç”¨è„ˆè¡
    self.pulse = True  # å¼·åˆ¶ä½¿ç”¨è„ˆè¡
    
    if cycle_override is not None:
        # ç”¨æˆ¶æ‰‹å‹•æŒ‡å®š cycle
        self.cycle = cycle_override
        self.pulse_mode = "manual"
    else:
        # è‡ªå‹•è¨ˆç®— cycleï¼ˆæ¨¡ä»¿ Lumerical é‚è¼¯ï¼‰
        if self.is_single_frequency:
            # å–®é »ï¼šè¼ƒå¤šé€±æœŸï¼Œç”¢ç”Ÿæ›´çª„çš„é »è­œ
            if self.optimize_for_short_pulse:
                self.cycle = 5   # å°æ‡‰ Lumerical çš„ "standard" è„ˆè¡
            else:
                self.cycle = 10  # æ›´é•·è„ˆè¡ï¼Œæ›´ç²¾ç¢º
            self.pulse_mode = "single_freq_auto"
        else:
            # å¯¬é »ï¼šæ ¹æ“šç›¸å°é »å¯¬èª¿æ•´
            if self.optimize_for_short_pulse:
                # çŸ­è„ˆè¡ï¼Œå°æ‡‰ Lumerical çš„ "broadband" è„ˆè¡
                self.cycle = max(2, min(4, int(1.0 / max(self.relative_bandwidth, 0.1))))
            else:
                # ç¨é•·è„ˆè¡ï¼Œæ¸›å°‘é »ç‡ç¯„åœå¤–çš„åŠŸç‡
                self.cycle = max(3, min(8, int(1.5 / max(self.relative_bandwidth, 0.05))))
            self.pulse_mode = "broadband_auto"
    
    # è¨­å®šè„ˆè¡é¡å‹æ¨™ç±¤ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
    if self.is_single_frequency:
        self.lumerical_pulse_type = "standard"
    else:
        self.lumerical_pulse_type = "broadband"

def get_lumerical_info(self):
    """è¿”å› Lumerical é¢¨æ ¼çš„è³‡è¨Š"""
    return {
        'input_style': self.input_style,
        'is_single_frequency': self.is_single_frequency,
        'lumerical_pulse_type': self.lumerical_pulse_type,
        'pulse_mode': self.pulse_mode,
        'optimize_for_short_pulse': self.optimize_for_short_pulse,
        
        # æ³¢é•·è³‡è¨Š
        'wavelength_min_nm': self.wavelength_min * 1e9,
        'wavelength_max_nm': self.wavelength_max * 1e9,
        'wavelength_center_nm': self.wavelength * 1e9,
        'wavelength_span_nm': self.wavelength_span * 1e9,
        
        # é »ç‡è³‡è¨Š
        'frequency_center_THz': self.frequency / 1e12,
        'frequency_min_THz': self.frequency_min / 1e12,
        'frequency_max_THz': self.frequency_max / 1e12,
        'frequency_bandwidth_THz': self.frequency_bandwidth / 1e12,
        'relative_bandwidth_percent': self.relative_bandwidth * 100,
        
        # è„ˆè¡è³‡è¨Š
        'pulse_cycles': self.cycle,
        'pulse_duration_periods': self.cycle,
        'pulse_duration_fs': self.cycle * self.period * 1e15,
    }

def print_lumerical_info(self):
    """å°å‡º Lumerical é¢¨æ ¼çš„è³‡è¨Š"""
    info = self.get_lumerical_info()
    
    print(f"ğŸ“Š ComplexPlaneWave: {self.name or 'unnamed'}")
    print(f"   Input Style: {info['input_style']}")
    print(f"   Source Type: {'Single Frequency' if info['is_single_frequency'] else 'Broadband'}")
    print(f"   Pulse Type: {info['lumerical_pulse_type']}")
    print(f"   Pulse Mode: {info['pulse_mode']}")
    print()
    
    if info['is_single_frequency']:
        print(f"ğŸ¯ Single Frequency Setting:")
        print(f"   Wavelength: {info['wavelength_center_nm']:.1f} nm")
        print(f"   Frequency: {info['frequency_center_THz']:.2f} THz")
    else:
        print(f"ğŸŒˆ Broadband Setting:")
        print(f"   Wavelength Range: {info['wavelength_min_nm']:.1f} - {info['wavelength_max_nm']:.1f} nm")
        print(f"   Center Wavelength: {info['wavelength_center_nm']:.1f} nm")
        print(f"   Span: {info['wavelength_span_nm']:.1f} nm ({info['relative_bandwidth_percent']:.1f}%)")
        print(f"   Frequency Range: {info['frequency_min_THz']:.2f} - {info['frequency_max_THz']:.2f} THz")
    print()
    
    print(f"âš¡ Pulse Configuration:")
    print(f"   Always Pulse: {self.pulse}")
    print(f"   Cycles: {info['pulse_cycles']}")
    print(f"   Duration: {info['pulse_duration_fs']:.1f} fs")
    print(f"   Optimize for Short Pulse: {info['optimize_for_short_pulse']}")
    print()
    
    print(f"ğŸ’¡ How it works (Lumerical style):")
    if info['is_single_frequency']:
        print(f"   â€¢ Longer pulse ({info['pulse_cycles']} cycles) creates narrow spectrum")
        print(f"   â€¢ FFT extracts steady-state response at {info['frequency_center_THz']:.2f} THz")
        print(f"   â€¢ Result: Perfect CW response at target frequency")
    else:
        print(f"   â€¢ Shorter pulse ({info['pulse_cycles']} cycles) creates broad spectrum") 
        print(f"   â€¢ FFT extracts responses across {info['frequency_min_THz']:.2f}-{info['frequency_max_THz']:.2f} THz")
        print(f"   â€¢ Result: Broadband frequency response from single simulation")

# ä¿æŒå…¶ä»–åŸæœ‰æ–¹æ³•ä¸è®Š
def _register_grid(self, grid, x, y, z):
    """åŸæœ‰çš„ _register_grid æ–¹æ³•ä¿æŒä¸è®Š"""
    # ... ä¿æŒåŸæœ‰å¯¦ç¾
    pass

def update_E(self):
    """åŸæœ‰çš„ update_E æ–¹æ³•ä¿æŒä¸è®Š"""
    # ... ä¿æŒåŸæœ‰å¯¦ç¾
    pass

def update_H(self):
    """åŸæœ‰çš„ update_H æ–¹æ³•ä¿æŒä¸è®Š"""
    # ... ä¿æŒåŸæœ‰å¯¦ç¾
    pass

# æ–°å¢ä¾¿æ·å‰µå»ºæ–¹æ³•
@classmethod
def single_frequency(cls, wavelength: float, **kwargs):
    """ä¾¿æ·æ–¹æ³•ï¼šå‰µå»ºå–®é »å…‰æºï¼ˆLumerical é¢¨æ ¼ï¼‰"""
    return cls(wavelength_min=wavelength, wavelength_max=wavelength, **kwargs)

@classmethod
def broadband(cls, wavelength_min: float, wavelength_max: float, **kwargs):
    """ä¾¿æ·æ–¹æ³•ï¼šå‰µå»ºå¯¶é »å…‰æºï¼ˆLumerical é¢¨æ ¼ï¼‰"""
    return cls(wavelength_min=wavelength_min, wavelength_max=wavelength_max, **kwargs)

@classmethod
def broadband_center_span(cls, wavelength_center: float, wavelength_span: float, **kwargs):
    """ä¾¿æ·æ–¹æ³•ï¼šå‰µå»ºå¯¬é »å…‰æºï¼ˆä¸­å¿ƒ+è·¨åº¦æ–¹å¼ï¼‰"""
    wavelength_min = wavelength_center - wavelength_span / 2
    wavelength_max = wavelength_center + wavelength_span / 2
    return cls(wavelength_min=wavelength_min, wavelength_max=wavelength_max, **kwargs)
```

# ä½¿ç”¨ç¤ºä¾‹

def demo_modified_complexplanewave():
â€œâ€â€œå±•ç¤ºä¿®æ”¹å¾Œçš„ ComplexPlaneWave ç”¨æ³•â€â€â€

```
print("=== ä¿®æ”¹å¾Œçš„ ComplexPlaneWave ä½¿ç”¨ç¯„ä¾‹ ===\n")

# 1. èˆŠå¼ç”¨æ³•ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
print("1. èˆŠå¼ç”¨æ³•ï¼ˆå‘å¾Œå…¼å®¹ï¼‰:")
source_old = ComplexPlaneWave(wavelength=1550e-9, name="legacy_source")
source_old.print_lumerical_info()

print("\n" + "="*60 + "\n")

# 2. Lumerical é¢¨æ ¼ï¼šå–®é »
print("2. Lumerical é¢¨æ ¼ï¼šå–®é » (min=max)")
source_single = ComplexPlaneWave(
    wavelength_min=1550e-9, 
    wavelength_max=1550e-9,
    name="single_freq"
)
source_single.print_lumerical_info()

print("\n" + "="*60 + "\n")

# 3. Lumerical é¢¨æ ¼ï¼šå¯¬é »
print("3. Lumerical é¢¨æ ¼ï¼šå¯¬é » (minâ‰ max)")
source_broad = ComplexPlaneWave(
    wavelength_min=1500e-9,
    wavelength_max=1600e-9,
    optimize_for_short_pulse=True,
    name="broadband"
)
source_broad.print_lumerical_info()

print("\n" + "="*60 + "\n")

# 4. ä¾¿æ·æ–¹æ³•
print("4. ä¾¿æ·æ–¹æ³•:")
source_conv1 = ComplexPlaneWave.single_frequency(1550e-9)
source_conv2 = ComplexPlaneWave.broadband_center_span(1550e-9, 100e-9)

print("å–®é »ä¾¿æ·æ–¹æ³•:")
source_conv1.print_lumerical_info()

print("\nä¸­å¿ƒ+è·¨åº¦ä¾¿æ·æ–¹æ³•:")
source_conv2.print_lumerical_info()
```

if **name** == â€œ**main**â€:
demo_modified_complexplanewave()