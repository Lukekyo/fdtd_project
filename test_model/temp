# é˜»æŠ—å•é¡Œä¿®æ­£å·¥å…·

import numpy as np

def fix_impedance_problem(grid, grid_spacing):
â€œâ€â€
ä¿®æ­£FDTDä¸­çš„é˜»æŠ—å•é¡Œï¼ˆHå ´éå¤§å•é¡Œï¼‰
â€œâ€â€

```
print("ğŸ”§ é˜»æŠ—å•é¡Œä¿®æ­£")
print("="*50)

# 1. è¨ºæ–·ç•¶å‰ç‹€æ³
E_max = float(np.max(np.abs(grid.E)))
H_max = float(np.max(np.abs(grid.H)))
current_impedance = E_max / H_max if H_max > 0 else 0
target_impedance = 377.0

print(f"ç•¶å‰ç‹€æ³:")
print(f"  |E|_max = {E_max:.3e}")
print(f"  |H|_max = {H_max:.3e}")
print(f"  å¯¦éš›é˜»æŠ— = {current_impedance:.1f} Î©")
print(f"  ç›®æ¨™é˜»æŠ— = {target_impedance:.1f} Î©")

# 2. è¨ˆç®—ä¿®æ­£å› å­
correction_factor = current_impedance / target_impedance
print(f"\nä¿®æ­£å› å­ = {correction_factor:.2f}")
print(f"éœ€è¦å°‡Hå ´é™¤ä»¥ {correction_factor:.2f}")

# 3. åˆ†æå•é¡Œæ ¹æº
print(f"\nğŸ” å•é¡Œæ ¹æºåˆ†æ:")

# æª¢æŸ¥æ™‚é–“æ­¥é•·
c = 3e8
expected_dt = grid.courant_number * grid_spacing / c
actual_dt = grid.time_step
dt_ratio = actual_dt / expected_dt

print(f"  æ™‚é–“æ­¥é•·æª¢æŸ¥:")
print(f"    é æœŸ dt = {expected_dt:.2e} s")
print(f"    å¯¦éš› dt = {actual_dt:.2e} s")
print(f"    æ¯”ä¾‹ = {dt_ratio:.2e}")

if abs(dt_ratio - 1) > 0.1:
    print(f"    âŒ æ™‚é–“æ­¥é•·ç•°å¸¸ï¼")
    time_step_problem = True
else:
    print(f"    âœ… æ™‚é–“æ­¥é•·æ­£å¸¸")
    time_step_problem = False

# æª¢æŸ¥ç‰©ç†å¸¸æ•¸
mu0 = 4e-7 * np.pi
expected_h_coeff = actual_dt / mu0

print(f"\n  Hå ´æ›´æ–°ä¿‚æ•¸æª¢æŸ¥:")
print(f"    ç†è«–ä¿‚æ•¸ dt/Î¼â‚€ = {expected_h_coeff:.2e}")
print(f"    å¦‚æœä¿‚æ•¸éå¤§ {correction_factor:.0f} å€ï¼Œèªªæ˜:")

if correction_factor > 100:
    print(f"    âŒ Hå ´æ›´æ–°ä¿‚æ•¸åš´é‡éå¤§")
    print(f"    å¯èƒ½åŸå› ï¼š")
    print(f"      1. time_step è¨ˆç®—éŒ¯èª¤")
    print(f"      2. Î¼â‚€ å€¼éŒ¯èª¤")
    print(f"      3. curl_E å‡½æ•¸æœ‰é¡å¤–ä¿‚æ•¸")
    print(f"      4. update_H ä¸­æœ‰é‡è¤‡ä¿‚æ•¸")

return correction_factor, time_step_problem
```

def apply_temporary_fix(grid, correction_factor):
â€œâ€â€
æ‡‰ç”¨è‡¨æ™‚ä¿®æ­£ï¼ˆåƒ…ç”¨æ–¼æ¸¬è©¦ï¼‰
â€œâ€â€
print(fâ€\nğŸš¨ æ‡‰ç”¨è‡¨æ™‚ä¿®æ­£ï¼ˆåƒ…ç”¨æ–¼æ¸¬è©¦ï¼‰â€)
print(fâ€å°‡Hå ´é™¤ä»¥ {correction_factor:.2f}â€)

```
# ä¿å­˜åŸå§‹Hå ´
H_original = grid.H.copy()

# ä¿®æ­£Hå ´
grid.H = grid.H / correction_factor

# é‡æ–°æª¢æŸ¥é˜»æŠ—
E_max = float(np.max(np.abs(grid.E)))
H_max = float(np.max(np.abs(grid.H)))
new_impedance = E_max / H_max if H_max > 0 else 0

print(f"ä¿®æ­£å¾Œé˜»æŠ—: {new_impedance:.1f} Î©")

if abs(new_impedance - 377) < 50:
    print(f"âœ… é˜»æŠ—ä¿®æ­£æˆåŠŸï¼")
    return True, H_original
else:
    print(f"âŒ é˜»æŠ—ä»ç„¶ç•°å¸¸")
    grid.H = H_original  # æ¢å¾©åŸå§‹å€¼
    return False, H_original
```

def investigate_root_cause(grid, grid_spacing):
â€œâ€â€
æ·±å…¥èª¿æŸ¥æ ¹æœ¬åŸå› 
â€œâ€â€
print(fâ€\nğŸ”¬ æ·±å…¥èª¿æŸ¥æ ¹æœ¬åŸå› â€)
print(â€=â€*40)

```
# 1. æª¢æŸ¥Gridåˆå§‹åŒ–åƒæ•¸
print(f"1. Gridåˆå§‹åŒ–æª¢æŸ¥:")
print(f"   courant_number: {grid.courant_number}")
print(f"   time_step: {grid.time_step:.2e}")
print(f"   grid_spacing: {grid_spacing:.2e}")

# 2. æª¢æŸ¥ç‰©ç†å¸¸æ•¸
print(f"\n2. ç‰©ç†å¸¸æ•¸æª¢æŸ¥:")

# æª¢æŸ¥grid.pyä¸­çš„å¸¸æ•¸å®šç¾©
c_from_grid = grid_spacing * grid.courant_number / grid.time_step
print(f"   å¾ç¶²æ ¼æ¨ç®—çš„å…‰é€Ÿ: {c_from_grid:.2e} m/s")
print(f"   æ¨™æº–å…‰é€Ÿ: 3.0e8 m/s")

c_error = abs(c_from_grid - 3e8) / 3e8 * 100
print(f"   å…‰é€Ÿèª¤å·®: {c_error:.1f}%")

if c_error > 10:
    print(f"   âŒ å…‰é€Ÿè¨ˆç®—ç•°å¸¸ï¼")
    print(f"   å¯èƒ½å•é¡Œï¼š")
    print(f"     - grid_spacing å–®ä½éŒ¯èª¤")
    print(f"     - time_step è¨ˆç®—éŒ¯èª¤")
    print(f"     - courant_number è¨­å®šéŒ¯èª¤")

# 3. æª¢æŸ¥ææ–™åƒæ•¸
print(f"\n3. ææ–™åƒæ•¸æª¢æŸ¥:")

# æª¢æŸ¥ inverse_permeability
perm_sample = grid.inverse_permeability[grid.Nx//2, 0, grid.Nz//2, 0]
perm_value = float(perm_sample.real) if hasattr(perm_sample, 'real') else float(perm_sample)

print(f"   inverse_permeability: {perm_value:.6f}")

if abs(perm_value - 1.0) > 0.01:
    print(f"   âŒ inverse_permeability â‰  1.0")
    print(f"   é€™æœƒå°è‡´Hå ´æ›´æ–°ç•°å¸¸ï¼")
else:
    print(f"   âœ… inverse_permeability = 1.0")

return c_error, perm_value
```

def suggest_permanent_fixes(correction_factor, time_step_problem, c_error, perm_value):
â€œâ€â€
å»ºè­°æ°¸ä¹…æ€§ä¿®æ­£æ–¹æ¡ˆ
â€œâ€â€
print(fâ€\nğŸ’¡ æ°¸ä¹…æ€§ä¿®æ­£å»ºè­°â€)
print(â€=â€*40)

```
print(f"æ ¹æ“šè¨ºæ–·çµæœï¼Œå»ºè­°æŒ‰å„ªå…ˆç´šä¿®æ­£ï¼š")

# å„ªå…ˆç´š1ï¼šæ™‚é–“æ­¥é•·å•é¡Œ
if time_step_problem or c_error > 10:
    print(f"\nğŸ¯ å„ªå…ˆç´š1ï¼šä¿®æ­£æ™‚é–“æ­¥é•·è¨ˆç®—")
    print(f"   å•é¡Œï¼šGrid.__init__() ä¸­çš„ time_step è¨ˆç®—")
    print(f"   æª¢æŸ¥ï¼š")
    print(f"     self.time_step = self.courant_number * self.grid_spacing / bd.c0")
    print(f"   å¯èƒ½å•é¡Œï¼š")
    print(f"     - bd.c0 çš„å€¼ä¸æ˜¯ 3e8")
    print(f"     - grid_spacing å–®ä½éŒ¯èª¤")
    print(f"     - courant_number è¨ˆç®—éŒ¯èª¤")
    print(f"   ä¿®æ­£æ–¹æ³•ï¼š")
    print(f"     åœ¨ Grid.__init__() ä¸­æ·»åŠ èª¿è©¦ï¼š")
    print(f"     print(f'bd.c0 = {{bd.c0}}')") 
    print(f"     print(f'time_step calculation: {{self.courant_number}} * {{self.grid_spacing}} / {{bd.c0}}')")

# å„ªå…ˆç´š2ï¼šææ–™åƒæ•¸å•é¡Œ
if abs(perm_value - 1.0) > 0.01:
    print(f"\nğŸ¯ å„ªå…ˆç´š2ï¼šä¿®æ­£ææ–™åƒæ•¸")
    print(f"   å•é¡Œï¼šinverse_permeability â‰  1.0")
    print(f"   æª¢æŸ¥ï¼šGrid.__init__() ä¸­çš„ææ–™åƒæ•¸åˆå§‹åŒ–")
    print(f"   ä¿®æ­£ï¼šç¢ºä¿ permeability=1.0 æ­£ç¢ºè¨­å®š")

# å„ªå…ˆç´š3ï¼šHå ´æ›´æ–°æ–¹ç¨‹
if correction_factor > 10:
    print(f"\nğŸ¯ å„ªå…ˆç´š3ï¼šæª¢æŸ¥Hå ´æ›´æ–°æ–¹ç¨‹")
    print(f"   å•é¡Œï¼šHå ´æ›´æ–°ä¿‚æ•¸éå¤§ {correction_factor:.0f} å€")
    print(f"   æª¢æŸ¥ä½ç½®ï¼š")
    print(f"     1. grid.py ä¸­çš„ update_H() å‡½æ•¸")
    print(f"     2. curl_E() å‡½æ•¸æ˜¯å¦æœ‰é¡å¤–ä¿‚æ•¸")
    print(f"     3. æ˜¯å¦æœ‰é‡è¤‡çš„æ™‚é–“æˆ–ç©ºé–“ä¿‚æ•¸")
    print(f"   ä¿®æ­£æ–¹æ³•ï¼š")
    print(f"     åœ¨ update_H() ä¸­æ·»åŠ èª¿è©¦ï¼š")
    print(f"     print(f'courant_number: {{self.courant_number}}')") 
    print(f"     print(f'inverse_permeability sample: {{self.inverse_permeability[10,0,10,0]}}')")
    print(f"     curl_max = bd.max(bd.abs(curl_E(self.E)))")
    print(f"     print(f'curl_E max: {{curl_max}}')")
```

def complete_impedance_fix(grid, grid_spacing):
â€œâ€â€
å®Œæ•´çš„é˜»æŠ—å•é¡Œä¿®æ­£æµç¨‹
â€œâ€â€
print(â€œğŸš¨ å®Œæ•´é˜»æŠ—å•é¡Œè¨ºæ–·èˆ‡ä¿®æ­£â€)
print(â€=â€*60)

```
# æ­¥é©Ÿ1ï¼šè¨ºæ–·å•é¡Œ
correction_factor, time_step_problem = fix_impedance_problem(grid, grid_spacing)

# æ­¥é©Ÿ2ï¼šæ·±å…¥èª¿æŸ¥
c_error, perm_value = investigate_root_cause(grid, grid_spacing)

# æ­¥é©Ÿ3ï¼šå˜—è©¦è‡¨æ™‚ä¿®æ­£ï¼ˆç”¨æ–¼é©—è­‰ï¼‰
print(f"\n" + "="*50)
temp_fix_success, H_original = apply_temporary_fix(grid, correction_factor)

if temp_fix_success:
    print(f"\nâœ… è‡¨æ™‚ä¿®æ­£æˆåŠŸï¼è­‰æ˜å•é¡Œç¢ºå¯¦æ˜¯Hå ´ä¿‚æ•¸éŒ¯èª¤")
    print(f"ğŸ“‹ ç¾åœ¨å¯ä»¥ç”¨ä¿®æ­£å¾Œçš„Hå ´è¨ˆç®—æ­£ç¢ºçš„T/R")
    
    # æ¸¬è©¦ä¸€ä¸‹T/Rè¨ˆç®—
    print(f"\nğŸ§ª æ¸¬è©¦ä¿®æ­£å¾Œçš„T/Rè¨ˆç®—...")
    test_power_calculation(grid, grid_spacing)
    
    # æ¢å¾©åŸå§‹Hå ´
    grid.H = H_original
    print(f"\nâš ï¸ Hå ´å·²æ¢å¾©åŸå§‹å€¼")

# æ­¥é©Ÿ4ï¼šæä¾›æ°¸ä¹…ä¿®æ­£å»ºè­°
suggest_permanent_fixes(correction_factor, time_step_problem, c_error, perm_value)

return correction_factor
```

def test_power_calculation(grid, grid_spacing):
â€œâ€â€
æ¸¬è©¦ä¿®æ­£å¾Œçš„åŠŸç‡è¨ˆç®—
â€œâ€â€
try:
# ç°¡å–®çš„åŠŸç‡è¨ˆç®—æ¸¬è©¦
if hasattr(grid, â€˜Tâ€™) and hasattr(grid.T, â€˜Sâ€™) and len(grid.T.S) > 0:
# é‡æ–°è¨ˆç®—æœ€å¾Œä¸€æ­¥çš„Poyntingå‘é‡
grid.T.detect_S()
grid.R.detect_S()

```
        P_T = float(grid.T.S[-1]) if grid.T.S else 0
        P_R = float(abs(grid.R.S[-1])) if grid.R.S else 0
        
        # è¨ˆç®—å…¥å°„åŠŸç‡ï¼ˆç°¡åŒ–ï¼‰
        E_max = float(np.max(np.abs(grid.E)))
        source_length = grid.Nx * grid_spacing
        P_incident = 0.5 * E_max**2 / 377.0 * source_length
        
        T_ratio = P_T / P_incident if P_incident > 0 else 0
        R_ratio = P_R / P_incident if P_incident > 0 else 0
        
        print(f"   ä¿®æ­£å¾ŒåŠŸç‡è¨ˆç®—:")
        print(f"     P_incident = {P_incident:.2e} W/m")
        print(f"     P_transmitted = {P_T:.2e} W/m")
        print(f"     P_reflected = {P_R:.2e} W/m")
        print(f"     T = {T_ratio:.3f} ({T_ratio*100:.1f}%)")
        print(f"     R = {R_ratio:.3f} ({R_ratio*100:.1f}%)")
        print(f"     T + R = {T_ratio + R_ratio:.3f}")
        
        # èˆ‡ç†è«–å€¼æ¯”è¼ƒ
        R_theory = ((1.0 - 1.5) / (1.0 + 1.5))**2
        T_theory = 1 - R_theory
        
        print(f"\n   èˆ‡ç†è«–å°æ¯”:")
        print(f"     ç†è«–: T={T_theory:.3f}, R={R_theory:.3f}")
        print(f"     è¨ˆç®—: T={T_ratio:.3f}, R={R_ratio:.3f}")
        
        if abs(T_ratio - T_theory) < 0.1 and abs(R_ratio - R_theory) < 0.1:
            print(f"     âœ… èˆ‡ç†è«–å€¼æ¥è¿‘ï¼ä¿®æ­£æœ‰æ•ˆ")
        else:
            print(f"     âš ï¸ ä»èˆ‡ç†è«–å€¼æœ‰å·®ç•°")
            
except Exception as e:
    print(f"   åŠŸç‡è¨ˆç®—æ¸¬è©¦å¤±æ•—: {e}")
```

# ä½¿ç”¨æ–¹æ³•

def usage_example():
â€œâ€â€
ä½¿ç”¨ç¤ºä¾‹
â€œâ€â€
print(â€â€â€
ğŸ”§ ä½¿ç”¨æ–¹æ³•ï¼š

1. åœ¨æ‚¨çš„ test_bloch_PW_xz4.py ä¸­æ·»åŠ ï¼š

# åœ¨æ¨¡æ“¬å®Œæˆå¾Œ

if **name** == â€œ**main**â€:
try:
results, grid = run_simulation(with_structure=True, total_steps=600)

```
    # è¨ºæ–·ä¸¦ä¿®æ­£é˜»æŠ—å•é¡Œ
    correction_factor = complete_impedance_fix(grid, grid_spacing)
    
except Exception as e:
    print(f"éŒ¯èª¤: {e}")
```

1. æ ¹æ“šè¼¸å‡ºçš„å»ºè­°ï¼Œæª¢æŸ¥ä¸¦ä¿®æ­£ï¼š
- Grid.**init**() ä¸­çš„ time_step è¨ˆç®—
- backend.py ä¸­çš„ c0 å€¼
- update_H() ä¸­çš„ä¿‚æ•¸
1. ä¿®æ­£å¾Œé‡æ–°é‹è¡Œæ¨¡æ“¬
   â€œâ€â€)

if **name** == â€œ**main**â€:
print(â€œé˜»æŠ—å•é¡Œä¿®æ­£å·¥å…·â€)
usage_example()